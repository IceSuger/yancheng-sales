# 解题思路  

最终线上名次14。

- 复赛A榜只用了特征工程+单模型XGBoost。

- 复赛B榜最终预测时融合了**机器学习算法模型**和**人工规则**两种方法。  
前者简单概括就是**特征工程+XGBoost**，后者都不用简单概括，本身就很简单，就是用A榜时预测的**上个月的销量乘个系数**来预测本月销量。

模型这里特征工程的大致思路就是：先将销量还原为原始销量（下面再细说），然后围绕车型（即不同的class_id）、车类型（即各个车型是轿车、SUV还是MPV）、车排量的等级（根据经验划了几个档次）、车是否为新能源车这几项分别归类来做了历史销量的一系列统计特征，此外再辅以一些车型本身的特点信息。

下面我分几个部分详细谈谈解题思路，其中数据探索分析EDA的过程及发现就不单独提出来说了，而是穿插在各个部分中间。

## 0. 看看评价指标
不同于初赛直接算RMSE，复赛的评价指标为RMSLE，即下式，其中参数意义不再赘述。
![评价指标](https://note.youdao.com/yws/public/resource/b1fac6368ce6469bfed546a0b1e310d3/xmlnote/2488EF57D50F40E38370AC1D19F7E7FB/5521)
上述评价函数中由于log的存在，使得应该被关注的重点不再是大绝对值的项，而是大**比例**的项。  
比如有的项很小，如0，而预测值为8，看起来绝对值上没差多少，但计算时是：![](https://note.youdao.com/yws/public/resource/b1fac6368ce6469bfed546a0b1e310d3/xmlnote/831E2978C40C4206847D3F1754D4AFB8/5524)
相比之下，如果原值1000，预测值1500，绝对值差了500，但计算误差时是：![](https://note.youdao.com/yws/public/resource/b1fac6368ce6469bfed546a0b1e310d3/xmlnote/B88DC09DDA4845FBA933AE6CC2B7FC75/5526)
高下立判呐！

事实上，评价指标为RMSLE，暗示了我们两点：1. **绝对值小的值**值得关注；2. 假设能够知道自己针对某个数据点的预测误差在一定范围内，那么应该尽量选择给出大的预测值，因为在正负差不多的误差范围内，预测偏小比预测偏大的后果更严重（这一点通过看log函数的图像即可理解）。

那么需要考虑一下数据集中数据的分布情况，对训练数据集做统计后发现，“小值”占的比例很大。如下图：
![](https://note.youdao.com/yws/public/resource/b1fac6368ce6469bfed546a0b1e310d3/xmlnote/63309BCD0F024B6F8E8A5CFF5DA823E6/5528)

进一步，由于回归模型优化的目标（如xgb回归时的目标reg:linear）通常为均方误差等，可以认为是盯着**绝对**误差去减小它，于是自然考虑在训练前将label列做`log1p`的变换，预测后再还原回去。**然而**……在线下验证集上验证这种做法的效果并不好（相比于不做变换直接训练，结果反而略微变差了）。

**不过**评价指标这里暗示了对“小值”应当更加关注，这对后面的原始销量还原、训练集构造、特征选取，都有指导意义。

## 1. 预处理
这里的预处理操作并不包括异常值清洗等，事实上这里所谓的预处理，也可以认为是特征工程的一部分。

1. 首先将同一省市、同一车型、同一年月的销量数据合并，即将整个训练集变为`(province_id, city_id, class_id, sale_date)`这个四元组唯一确定一条记录的形式；
2. 由于计划在特征工程中不涉及全表统计量，故可以在进一步提特征之前，先将测试集和训练集拼到一起，方便统一进行提特征的操作，而不用担心线下验证集上会有可能发生“数据穿越”的问题；
3. 对`String`类型的几列做处理：
	1. `sale_date`：分别转为 `bigint` 和 `datetime` 类型，便于后面的数据集拆分和特征构造；
	2. `displacement`：排量中的数字部分提取出来，丢掉后面的L和T；
	3. `if_charging`：转换为`bigint`；
	4. `rated_passenger`：取最大的值出来，如“5-7”则取7；
	5. `power`：取最小值，如“70/144”，取70；
4. 还原真实销量值：
	###### 这里稍微啰嗦一下。
	首先由于赛题中的说明：
	> 参赛者允许使用任何可公开的外部数据辅助预测。   
	
	我查了网上报道中[17年全年各月的乘用车销量概况](http://auto.sohu.com/s2018/sar132/index.shtml)，并对赛题数据集中各月销量做了统计，发现数据集中的销量比报道中的数据大很多。就各月销量总和来看，赛题数据与报道数据之间比值都在2~3倍，且不是同一个常数。那么结合之前观察数据集发现小值居多，首先猜测：可能是对原始销量做了变换`e^log_2(x)`，如下图中的蓝线所示（橙色线为赛题数据，灰色线为网上报道的值），从图上可以看出整体相对于报道值都偏小。我当时也猜测过其他变换方式，但尝试了几个发现都明显猜错了。

	直到后来，单独统计了十个左右的随机挑选出来的**某个具体城市的具体车型的历史销量**，本来目的是看看趋势，却意外地从数据中发现一个规律：有的车型这一列销量数据结尾都是0或5，有的显然都是2、3、4的整数倍，于是乎...我有一个大胆的想法...（当然可能其实这样的变换也是很常见很常用的...但对于我这个萌新来说还是很意外的...）可能是主办方分车型分别将原始销量值乘了1、2、3、4、5、6等等倍数。于是对数据集整体进行统计后，基本验证了我这个猜想，统计出各个车型所乘的倍数后，看了一下倍数的直方图，1~5这五个被乘系数的各自总量是接近的，当时还猜测过这背后会不会隐藏了什么leakage，当然进一步统计计算后我认为这个倍乘的系数应该是随机分的...
	
	统计各个车型对应的倍乘系数的方式是：利用窗口函数，分别统计该车型销量的distinct的最低、次低、第三低的值，并取其间的差的最小值作为该车型的被乘系数。当然这种方式有可能出现错误，但大体上应该还是可以的，而且这种方式应该也是比较方便省事的...

	![猜测原始销量](https://note.youdao.com/yws/public/resource/b1fac6368ce6469bfed546a0b1e310d3/xmlnote/4FCEC44EC68F4CBAB4351792D879BA6B/5530)

	**需要澄清一点：由于比赛规则强调不允许下载数据，我在比赛过程中分析数据的过程中并没有下载数据，上图是我现在赛后为了写解题思路时更形象可视，临时将平台上的统计数据拷贝出来，在Excel中绘制的。（赛后把部分统计值复制粘贴一下，应该不算犯规哈？）**
	也顺便吐槽一点，平台的可视化功能好像还不够强大（当然也可能是有这方面功能但我不会用...至少是没找到相关文档）...

5. 线下验证集的构造：
	我最初在线下构造了四个训练/验证集（A/B榜最初都是4个），A榜四个训练及验证集的划分分别如下：
	
命名 | 训练集（3年） | 测试集/验证集（1个月）|备注  
---|---|---|---
dataset0 | 2015.01~2017.12 | 2018.01 | 实际提交的
dataset1 | 2014.12~2017.11 | 2017.12 |1~4这四个数据集都是线下验证用的
dataset2 | 2014.11~2017.10 | 2017.11 |
dataset3 | 2014.01~2016.12 | 2017.01 |
dataset4 | 2013.12~2016.11 | 2016.12 |

B榜四个训练及验证集的划分分别如下：
	
命名 | 训练集（3年） | 测试集/验证集（1个月）|备注  
---|---|---|---
dataset0 | 2014.12~2017.12 | 2018.02 | 实际提交的
dataset1 | 2013.11~2016.11 | 2017.01 |1~4这四个数据集都是线下验证用的
dataset2 | 2013.12~2016.12 | 2017.02 |
dataset3 | 2012.12~2015.12 | 2016.02 |
dataset4 | 2014.10~2017.10 | 2017.12 |


	后来出于尽量保证线上线下一致，且平台资源也有限，A榜只用了dataset3，B榜只用了dataset2和3。


## 2.特征工程
### i.绝大部分特征都是围绕着各种分类后统计的历史销量及销量趋势来提的。
### ii.数据探索分析过程中的部分发现
a. 激增和骤降
根据相邻月份销量的差分和比值，我大致定义了销量激增和骤降，并对这两种情况在数据集中发生的情况进行的统计。比较重要的结论是：激增在各月发生的频率相差不大，骤降则在2月发生得明显多于其他月份。这个结论对后来训练集的选取有帮助。

b. 车的类型（轿车、SUV等）
无论是从初赛和复赛对数据的统计分析，还是从生活经验，还是从网上关于乘用车产销量的报道，都可以发现，轿车和SUV在不同时间有着不同的销量和销量走势，因此将其区分开来，必然有利于对销量的预测。
然而赛题数据并没有给出车型属于轿车还是SUV（或者也可能是我没发现...毕竟是刚过实习期的新司机...对车并不懂...），仅仅是标注了是否为MPV。于是只能根据经验和统计数据，大致地进行划分。对不同车型的外形参数统计后，发现车高`car_height`似乎有着与我的日常生活经验比较一致的、可以用于区分轿车和SUV的分布特点，如下图：![](https://note.youdao.com/yws/public/resource/b1fac6368ce6469bfed546a0b1e310d3/xmlnote/AA3CD27AD0494C6D805796BD583E9DE8/5532)
于是简单地指定一个规则：2厢且高度大于1600的车，是SUV。


### iii.特征简述
下面简单列一下构造了哪些特征、用了哪些特征吧，也包括了一部分前述的数据预处理的工作。代码运行说明中的特征工程部分（或源码中）提到的特征命名，与这里的描述相对应。
**说明**：特征列的命名中的`_c_`没有实际含义，`_d_`,`_dr_`和`_draft_`都表示演草，实际上表明相应的表和列都是中间结果。

1. **对`yc_passenger_car_sales`做除以倍数的处理【原赛题数据中的销量仍名为`sale_quantity`，还原后的销量为`real_sale`】**  

2. **分（省、市、车型、时间）统计销量和——即对应前述“数据预处理”第一步；**  

3. **车型自身特点的特征**  
	3.1 拼上`oc`特征（`oc`意为`only class`，即指此类特征为单纯依据车型自身特点提取的）  
	3.2 对排量等，归类  
		a. 根据车的厢数`compartment`和车高`height`共同判断该车型属于轿车还是SUV，此外由于数据中已经标出了MPV，故将车型归为四类：轿车、SUV、MPV、其他；  
		b. 排量分为：小于1、1 ~ 1.3、1.3 ~ 1.6、1.6 ~ 2.4、2.4以上；  
		c. 新能源分类采用原始数据里的值；  

4. **计算各类`som、ssm、fd、fr、fir`【B榜：最终都不要`som_1`, 且`ssm_`从2开始：`ssm_2_2, ssm_2_3`】**  
	4.1 省 市 车型 时间  
	4.2 省 市 时间  
	4.3 省 车型 时间  
	4.4 （全国）车型 时间    
	
	4.1 ~ 4.4 分别表示group by的参数。	
	实际上，A榜用了 4.1 ~ 4.4 的特征，但B榜由于时间和资源的限制，仅仅提了4.1的特征。  
	这一批特征命名含义分别为：`som`：单月销量、`ssm`：从本月往前数的累积销量、`fd`：不同月单月销量的差、`fr`：不同月单月销量的比值、`fir`：不同月销量间增长的比例（下降则为负）
	
	最终使用的特征分别是：过去一年内的各个月的单月销量、过去2个月至一年内的分别的累积销量、当月与前一个月的差/比/fir、前一个月与上上个月的差/比/fir、今年本月与去年本月的差/比/fir、去年本月与前年本月的差/比/fir；
5. **按车型自身特点分：轿车、SUV、MPV，新能源类别，大小排量，（厢数），品牌。这些变量，都可替换上面4.1 ~ 4.4中的“车型”变量。**  
	5.1 轿车/SUV/MPV，省、市、时间  
	5.2 排量分了几个档次  
	5.3 新能源类别，按赛题数据原有的新能源类别  
	5.4 品牌——由于时间、精力所限，没有加入这一部分特征，另一方面原因是，初赛时这一部分特征的效果并不好。  

6. **各种窗口函数，如rank、avg、max、min、median**  
	6.0.1 ~ 6.0.4	省 市 时间 上的：车型、车类型、排量、新能源销量  
	6.1.1 ~ 6.1.4	省 时间 上的：车型、车类型、排量、新能源销量——这一部分在A榜实现了，B榜没有  
	
7. **历史销量交叉特征**  
	7.1	省 市 车型  
	7.2 省 市 车类型  
	7.3 省 市 排量  
	7.4 省 市 新能源  
	
	仍然是分了上述几种不同的分类来进行分别统计。这一部分的特征主要是：某个时间段的均值/中位数/最大值/最小值，与另一个时间段的均值/中位数/最大值/最小值，做差和做比（做比这里通过+1平滑绕过了除零等问题）

8.	**时间**：年、月单独抽出来作为两列  


## 3.训练模型
1. 训练集的构造  
首先，在大致浏览过数据后，结合初赛的经验，没有选择使用全部6年的数据作为训练集，而是在提完特征后，对拆分出的五份数据集，都是使用最近三年的数据作为训练集。
其次，由于前述的EDA中的发现，2月具有一定特殊性，即2月发生骤降的可能性较大，而我之前提的特征，许多都在反映近几个月的销量走势，因此模型容易学习到近期涨，则下个月（或针对B榜确切地说是下下个月）也涨的趋势。因此尝试只选出近三年的训练集中目标为2月的记录作为训练集。线下验证（在dataset2和dataset3这两个预测目标均为二月的验证集上）的结果表明这种选择方式，能够有效降低针对二月的预测误差。

2. 模型  
模型就是XGBoost，没太多可说的。期初也尝试了平台上的GBDT，但对调参不熟悉，在验证集上取得的结果并不理想，因此后来放弃了GBDT。
XGB的参数，由于资源有限，在B榜也没有怎么调，仅仅大概尝试了两三组参数。

最终模型的预测结果要按各自对应的倍数`times`乘回去。
## 4.人工规则及融合
初赛中，在统计各个车型历史销量的走势及整体销量的走势等的基础上，人工指定了系数，直接乘到上个月的销量上来作为目标月份销量的预测值，效果还可以。所以在复赛中一开始也尝试了这个套路，结果并不尽人意。
然而啊...在B榜最后的提交时还是抱着一丝希望，对A榜中我预测的1月结果乘了0.6的比例作为对2月的预测值，然后将这个结果也放进了最终的融合当中。

多提一句。
在这个规则上，还考虑过一点，由于赛题规则开放一切可公开外部数据，于是尝试依据销量报道中对轿车、SUV等分别统计环比、同比销量涨跌的幅度，来进行这里的乘系数操作（*实际上，这就已经是在使用未来数据了，不过本题并没有要求不允许使用这种数据*）。但在线下验证集上试了一下，效果很差。我猜原因包括但不限于：1. 这种方法本身当然不是特别靠谱啦；2.我在前期特征工程中对轿车、SUV的区分做得不好。

最终融合的参数是：
1. XGB。训练集为过去三年的全部数据。round=150,seed=0的直接跳过一月预测二月；
2. XGB。训练集为过去三年的二月数据。换round=145,seed=1的预测二月的；
3. A榜一月的次优成绩v20180310（因为失误，最优成绩没有保存...），拿来乘以0.6。

三者比例：
	0.262
	0.61
	0.128


（然而，实际上融合之后就后悔了...因为A榜时也尝试过融合这种简单人工规则的做法，效果并不好...而且第一个XGB的结果也必然是偏大的，估计还不如换换第二个XGB的参数，跑两三个不一样的结果来融合，或者只提交单模型的结果）  

最终结果0.9780，排在B榜14名。
